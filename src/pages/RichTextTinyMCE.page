<apex:page lightningStylesheets="true">
    
    <apex:includeScript value="{!URLFOR($Resource.jquery_3_4_0_min_js)}"/>
    <apex:includeScript value="{!URLFOR($Resource.TinyMCE, 'tinymce/js/tinymce/tinymce.min.js')}"/> 
    <style>
        .ToggleBtn{
        appearance: button;
        -moz-appearance: button;
        -webkit-appearance: button;
        text-decoration: none;
        font: menu;
        color: aquaButtonText;
        display: inline-block;padding: 2px 8px;
        background-color: #CFEEF8;
        cursor: pointer;
        }
    </style>
    <div id="knowledgeDiv" style="padding-right: 1px;">
            
        <apex:form >
        <!--
            <div>
                <a  class="ToggleBtn" onclick="tinymce.execCommand('mceToggleEditor',false,'content');">
                    <span>Toggle HTML/TEXT</span>
                </a>
            </div>
            -->
            <textarea id="content1" name="content" style="width:100%;height:20rem;" class="mceEditor"></textarea>
        </apex:form>
    </div>
    
    <!--this is the initialization required for TINYMCE  -->
    <script type="text/javascript">
    
	    var parentHostName = '{!$CurrentPage.parameters.parentHostName}';

	    
		tinymce.init({
		  	mode : "specific_textareas",
			menubar: false,
			plugins: "fullpage",
		  	selector: 'textarea#content1',
		  	toolbar: 'formatselect fontselect fontsizeselect | bold italic underline strikethrough | forecolor backcolor | bullist numlist outdent indent | alignleft aligncenter alignright alignjustify | removeformat image customInsertButton code',
		  	width: "100%",
			height : "20rem",
		  	init_instance_callback: function (editor) {
			    editor.on('Change', function (e) {
			    	console.log("visualforce contentBody: " + tinymce.get('content1').getContent());

			      	parent.postMessage({event 	: "contentchange",
			      						data	: tinymce.get('content1').getContent()}, 
			      						parentHostName);
			    });
			},
		  	setup: function (editor) {
				editor.ui.registry.addButton('customInsertButton', {
			      	text: 'Add Image',
			      	onAction: function (_) {
			      		parent.postMessage({event 	: "showimageselector"}, 
			      						parentHostName);
			        //editor.insertContent('&nbsp;<strong>It\'s my button!</strong>&nbsp;');
			      	}
		    	});
		  	}
		});


    </script>
    
    <script>
        var lastDivHeight = 0;
        var parentHostName = '{!$CurrentPage.parameters.parentHostName}';

        window.addEventListener("message", function(event){
        	if (event.origin == parentHostName) {
        		var parameters = event.data;
	            console.log("message visulforce handler: " + JSON.stringify(parameters));
	            switch(parameters.event){
            		case "contentchange":
            			setBody(parameters.data);
            			break;
            		case "insertimage":
            			insertImage(parameters.data);
            			break;
            	}
	        }
        }, false);

        function insertImage(url){
	        console.log("insertImage: " + url);
        	tinymce.activeEditor.insertContent('<img src="' + url + '" />');
	        console.log("insertImage end");
        }

        function setBody(body){
			tinymce.activeEditor.setContent(body || "");
        }
    </script>
    
</apex:page>